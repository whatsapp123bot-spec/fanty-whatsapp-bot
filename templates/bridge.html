<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîó Conectar WhatsApp no oficial</title>
  <style>
    body{font-family: Arial, sans-serif; margin:0; background:#f6f7fb; color:#222}
    header{background:#343a40;color:#fff;padding:16px}
    main{max-width:820px;margin:24px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.08)}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;color:#fff;font-weight:600;text-decoration:none}
    .btn-secondary{background:#6c757d}
    .btn-primary{background:#0b5ed7}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{padding:16px;border:1px solid #eee;border-radius:12px}
    .help{color:#666;font-size:13px}
    .qr-box{display:flex;align-items:center;justify-content:center;background:#f8f9fa;border:1px dashed #ddd;border-radius:12px;min-height:320px}
  </style>
</head>
<body>
  <header>
    <h1>üîó Conectar WhatsApp no oficial (whatsapp-web.js)</h1>
  </header>
  <main>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <a class="btn btn-secondary" href="/settings?key={{ key }}">‚Üê Volver a configuraci√≥n</a>
      <span class="help">Escanea el QR solo si deseas usar la integraci√≥n no oficial (WhatsApp Web). Si no escaneas, nada cambia.</span>
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0">1) Inicia el bridge</h3>
        <ol>
          <li>Abre una terminal y ejecuta el bridge:</li>
          <li class="help">En Windows, dentro de la carpeta <code>bridge</code> del proyecto:</li>
        </ol>
        <pre class="help" style="background:#f8f9fa;padding:8px;border-radius:8px">cd bridge
npm install
npm start</pre>
        <p class="help">El bridge mostrar√° el QR en consola y tambi√©n aqu√≠ abajo. Mant√©n esa terminal abierta.</p>
      </div>
      <div class="card">
        <h3 style="margin-top:0">2) Estado</h3>
        <div id="statusBox" class="help">Verificando bridge‚Ä¶</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-top:0">3) Escanear c√≥digo QR</h3>
      <div id="qrBox" class="qr-box">
        <div id="qrMsg" class="help">Si el bridge est√° activo y esperando, ver√°s el QR aqu√≠. Si ya est√° conectado, no ser√° necesario.</div>
      </div>
    </div>
  </main>

  <script>
    const key = encodeURIComponent('{{ key }}');
    const statusBox = document.getElementById('statusBox');
    const qrBox = document.getElementById('qrBox');
    const qrMsg = document.getElementById('qrMsg');
    let imgEl = null;

    async function poll() {
      try {
        const r = await fetch(`/internal/bridge/status?key=${key}`);
        const data = await r.json();
        if (!data.ok) {
          statusBox.textContent = 'Bridge no disponible. Aseg√∫rate de correr "npm start" en la carpeta bridge.';
          clearQR();
        } else {
          const st = data.status || {};
          statusBox.textContent = st.connected ? '‚úÖ Conectado' : (st.has_qr ? '‚åõ Esperando escaneo del QR‚Ä¶' : '‚è≥ Inicializando‚Ä¶');
          if (st.connected) {
            clearQR();
          } else if (st.has_qr) {
            ensureQR();
          }
        }
      } catch (e) {
        statusBox.textContent = 'No se pudo contactar el bridge. ¬øEst√° corriendo?';
        clearQR();
      }
    }

    function ensureQR() {
      if (!imgEl) {
        qrMsg && (qrMsg.style.display = 'none');
        imgEl = document.createElement('img');
        imgEl.alt = 'QR WhatsApp';
        imgEl.style.maxWidth = '100%';
        imgEl.style.maxHeight = '360px';
        qrBox.appendChild(imgEl);
      }
      imgEl.src = `/internal/bridge/qr?key=${key}&t=${Date.now()}`;
    }

    function clearQR() {
      if (imgEl) {
        imgEl.remove();
        imgEl = null;
      }
      if (qrMsg) {
        qrMsg.style.display = '';
      }
    }

    setInterval(poll, 2000);
    poll();
  </script>
</body>
</html>
