<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öôÔ∏è Configuraci√≥n ‚Äî Cuentas de WhatsApp</title>
  <style>
    body{font-family: Arial, sans-serif; margin:0; background:#f6f7fb; color:#222}
    header{background:#343a40;color:#fff;padding:16px}
    main{max-width:920px;margin:24px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.08)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;color:#fff;font-weight:600;text-decoration:none}
    .btn-secondary{background:#6c757d}
    .btn-danger{background:#b00020}
    .btn-primary{background:#0b5ed7}
    .btn-success{background:#198754}
    .row{display:grid;grid-template-columns:200px 1fr;gap:8px;align-items:center;margin-bottom:8px}
    .help{font-size:12px;color:#666}
    input[type=text],input[type=password]{padding:8px;border:1px solid #ddd;border-radius:8px;width:100%}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#e9ecef}
    .badge.default{background:#d1e7dd;color:#0f5132}
    .top-actions{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  </style>
</head>
<body>
  <header>
    <h1>‚öôÔ∏è Configuraci√≥n ‚Äî Cuentas de WhatsApp</h1>
  </header>
  <main>
    {% if message %}
      <div style="background:#f0f5ff;border:1px solid #b3ccff;padding:10px;border-radius:8px;margin-bottom:12px">{{ message }}</div>
    {% endif %}
    <div class="top-actions">
      <a class="btn btn-secondary" href="/?">‚Üê Volver</a>
      <a class="btn btn-primary" href="/bridge?key={{ key }}">üì≤ Escanear c√≥digo (no oficial)</a>
      {% if single_mode %}
        <span class="help">Modo simple: usa una sola cuenta activa. Guarda aqu√≠ el Phone Number ID y el Token; al cambiar, toma efecto inmediato.</span>
      {% else %}
        <span class="help">Administra m√∫ltiples cuentas de WhatsApp Cloud API o con√©ctate por WhatsApp Web escaneando el QR.</span>
      {% endif %}
    </div>

  <h2 style="margin-top:0">Cuentas registradas</h2>
  <div id="validate-msg" class="help" style="margin:6px 0 10px 0;"></div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Etiqueta</th>
          <th>Phone Number ID</th>
          {% if not single_mode %}<th>Estado</th>{% endif %}
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for a in accounts %}
          <tr>
            <td>{{ a.id }}</td>
            <td>{{ a.label }}</td>
            <td><code>{{ a.phone_number_id }}</code></td>
            {% if not single_mode %}
              <td>
                {% if a.is_default %}
                  <span class="badge default">Por defecto</span>
                {% else %}
                  <span class="badge">Secundaria</span>
                {% endif %}
              </td>
            {% endif %}
            <td>
              {% if not single_mode %}
                {% if not a.is_default %}
                  <a class="btn btn-success" href="/settings?action=make_default&id={{ a.id }}&key={{ key }}">Hacer por defecto</a>
                {% endif %}
                {% if a.is_default %}
                  <button class="btn btn-secondary validate-btn" type="button" data-id="{{ a.id }}">Validar</button>
                {% endif %}
              {% else %}
                <button class="btn btn-secondary validate-btn" type="button" data-id="{{ a.id }}">Validar</button>
              {% endif %}
              <button class="btn btn-danger delete-btn" type="button" data-id="{{ a.id }}">Eliminar</button>
            </td>
          </tr>
        {% endfor %}
        {% if not accounts %}
          <tr><td colspan="5" class="help">No hay cuentas registradas. Usa el formulario de abajo para a√±adir una.</td></tr>
        {% endif %}
      </tbody>
    </table>

    <h2>Agregar/Actualizar cuenta</h2>
    <form method="post" action="/settings">
      <input type="hidden" name="key" value="{{ key }}" />
      <div class="row">
        <label>Etiqueta</label>
        <input type="text" name="label" placeholder="Ej: Fanty Principal" required />
      </div>
      <div class="row">
        <label>Phone Number ID</label>
        <input type="text" name="phone_number_id" placeholder="ID num√©rico de WhatsApp" required />
      </div>
      <div class="row">
        <label>WhatsApp Token</label>
        <input type="password" name="whatsapp_token" placeholder="Token de acceso" required />
      </div>
      <div class="row">
        <label>Verify Token</label>
        <input type="text" name="verify_token" placeholder="Para verificaci√≥n del webhook" />
      </div>
      {% if not single_mode %}
        <div class="row">
          <label>Marcar por defecto</label>
          <input type="checkbox" name="is_default" value="1" />
        </div>
      {% endif %}
      <div class="row" style="grid-template-columns:1fr">
        <button class="btn btn-primary" type="submit">Guardar cuenta</button>
      </div>
    </form>

    {% if single_mode %}
      <p class="help">Esta instalaci√≥n usa una √∫nica cuenta activa. La m√°s reciente guardada se utilizar√° para el env√≠o.</p>
    {% else %}
      <p class="help">Nota: La vista previa y el webhook utilizar√°n la cuenta por defecto si no hay otra asociada al n√∫mero del usuario.</p>
    {% endif %}
    <script>
      async function validateAccount(id){
        const msg = document.getElementById('validate-msg');
        msg.textContent = 'Validando credenciales...';
        try{
          const res = await fetch(`/internal/validate_account?key={{ key }}&id=${id}`);
          const json = await res.json();
          if(json.ok){
            msg.textContent = `‚úÖ OK (status ${json.status}). PNID: ${json.account?.phone_number_id}`;
          }else{
            msg.textContent = `‚ùå Error (status ${json.status}): ${json.body}`;
          }
        }catch(e){
          msg.textContent = '‚ùå Error de red: '+e;
        }
      }
      document.querySelectorAll('.validate-btn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          validateAccount(id);
        });
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (ev) => {
          if(!confirm('¬øEliminar esta cuenta?')) return;
          const id = ev.currentTarget.getAttribute('data-id');
          try{
            const res = await fetch(`/internal/accounts/${id}?key={{ key }}`, { method: 'DELETE' });
            const json = await res.json();
            if(json.ok){
              // quitar fila de la tabla
              const tr = ev.currentTarget.closest('tr');
              if(tr) tr.remove();
              const msg = document.getElementById('validate-msg');
              msg.textContent = 'üóëÔ∏è Cuenta eliminada.';
            }else{
              alert('No se pudo eliminar (verifica que no exista protecci√≥n del servidor).');
            }
          }catch(e){
            alert('Error eliminando: '+e);
          }
        });
      });
    </script>
  </main>
</body>
</html>
